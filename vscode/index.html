<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HÃ  Ná»™i - Báº£n Ä‘á»“ du lá»‹ch</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="sidebar">
    <h2>ğŸ“ Báº£n Ä‘á»“ HÃ  Ná»™i</h2>
    <div class="search-container">
      <input type="text" id="search" class="search-input" placeholder="TÃ¬m Ä‘á»‹a Ä‘iá»ƒm...">
      <span class="search-icon">ğŸ”</span>
    </div>
    <div class="filter-group" id="filter-group">
      <!-- Danh sÃ¡ch loáº¡i Ä‘á»‹a Ä‘iá»ƒm sáº½ Ä‘Æ°á»£c táº¡o Ä‘á»™ng -->
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Khá»Ÿi táº¡o báº£n Ä‘á»“
    const map = L.map('map').setView([21.0285, 105.8542], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // LÆ°u trá»¯ marker vÃ  dá»¯ liá»‡u
    let markersByType = {};
    let allMarkers = [];
    let currentLocation = null;
    let currentRoute = null;
    let favoritePlaces = JSON.parse(localStorage.getItem('favorites')) || [];
    let activeType = null;

    // Biá»ƒu tÆ°á»£ng tÃ¹y chá»‰nh cho tá»«ng loáº¡i Ä‘á»‹a Ä‘iá»ƒm
    const icons = {
      'chÃ¹a': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/306/306342.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'nhÃ  thá»': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/188/188124.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'báº£o tÃ ng': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/167/167707.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'cÃ´ng viÃªn': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/293/293117.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'trung tÃ¢m thÆ°Æ¡ng máº¡i': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/308/308285.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'default': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/149/149060.png', iconSize: [32, 32], iconAnchor: [16, 32] })
    };

    // Emoji cho tá»«ng loáº¡i Ä‘á»‹a Ä‘iá»ƒm
    const typeEmojis = {
      'chÃ¹a': 'ğŸ›•',
      'nhÃ  thá»': 'â›ª',
      'báº£o tÃ ng': 'ğŸ›ï¸',
      'cÃ´ng viÃªn': 'ğŸŒ³',
      'trung tÃ¢m thÆ°Æ¡ng máº¡i': 'ğŸ›ï¸',
      'há»“': 'ğŸŒŠ',
      'di tÃ­ch': 'ğŸ¯',
      'cáº§u': 'ğŸŒ‰',
      'khu phá»‘': 'ğŸ˜ï¸',
      'kiáº¿n trÃºc': 'ğŸ›ï¸',
      'lÃ ng nghá»': 'ğŸ› ï¸',
      'Ä‘á»n': 'â›©ï¸',
      'chá»£': 'ğŸ›’',
      'khu vui chÆ¡i': 'ğŸ¢',
      'cao á»‘c': 'ğŸ™ï¸',
      'trung tÃ¢m há»™i nghá»‹': 'ğŸ›ï¸',
      'trÆ°á»ng Ä‘áº¡i há»c': 'ğŸ“',
      'khu Ä‘Ã´ thá»‹': 'ğŸ¬',
      'sÃ¢n váº­n Ä‘á»™ng': 'ğŸŸï¸',
      'Ä‘Æ°á»ng phá»‘': 'ğŸ›£ï¸',
      'ga tÃ u': 'ğŸš‚',
      'default': 'ğŸ“'
    };

    // Láº¥y vá»‹ trÃ­ hiá»‡n táº¡i cá»§a ngÆ°á»i dÃ¹ng
    navigator.geolocation.getCurrentPosition(
      (position) => {
        currentLocation = [position.coords.latitude, position.coords.longitude];
        L.marker(currentLocation, { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/684/684908.png', iconSize: [32, 32], iconAnchor: [16, 32] }) })
          .bindPopup('Vá»‹ trÃ­ cá»§a báº¡n')
          .addTo(map);
        map.setView(currentLocation, 13);
      },
      (error) => {
        console.error('Lá»—i láº¥y vá»‹ trÃ­:', error);
        alert('KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­ cá»§a báº¡n. Vui lÃ²ng báº­t Ä‘á»‹nh vá»‹ hoáº·c kiá»ƒm tra quyá»n truy cáº­p.');
      }
    );

    // Dá»¯ liá»‡u máº·c Ä‘á»‹nh náº¿u khÃ´ng táº£i Ä‘Æ°á»£c poi.geojson
    const defaultData = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "geometry": {
            "type": "Point",
            "coordinates": [105.8542, 21.0285]
          },
          "properties": {
            "name": "ChÃ¹a Má»™t Cá»™t",
            "description": "NgÃ´i chÃ¹a ná»•i tiáº¿ng á»Ÿ HÃ  Ná»™i",
            "type": "chÃ¹a",
            "image": "image/chuamotcot.jpg",
            "rating": 4.5,
            "address": "Äá»™i Cáº¥n, Ba ÄÃ¬nh, HÃ  Ná»™i",
            "opening_hours": "Má»Ÿ cá»­a: 07:00 - 18:00",
            "phone": "+84 24 3825 1234",
            "website": "http://chuamotcot.vn"
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Point",
            "coordinates": [105.852, 21.030]
          },
          "properties": {
            "name": "NhÃ  thá» Lá»›n",
            "description": "NhÃ  thá» CÃ´ng giÃ¡o ná»•i báº­t",
            "type": "nhÃ  thá»",
            "image": "image/nhatholon.jpg",
            "rating": 4.3,
            "address": "40 NhÃ  Chung, HÃ ng Trá»‘ng, HoÃ n Kiáº¿m, HÃ  Ná»™i",
            "opening_hours": "Má»Ÿ cá»­a: 08:00 - 20:00",
            "phone": "+84 24 3828 4567",
            "website": "http://nhatholonhanoi.vn"
          }
        }
      ]
    };

    // Táº£i dá»¯ liá»‡u GeoJSON
    fetch('data/poi.geojson')
      .then(res => {
        console.log('Tráº¡ng thÃ¡i pháº£n há»“i:', res.status, res.statusText);
        if (!res.ok) throw new Error('KhÃ´ng thá»ƒ táº£i GeoJSON: ' + res.statusText);
        return res.json();
      })
      .then(data => {
        console.log('Dá»¯ liá»‡u GeoJSON:', data);
        if (!data.features || !Array.isArray(data.features)) {
          throw new Error('Dá»¯ liá»‡u GeoJSON khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng');
        }
        loadPlaces(data);
      })
      .catch(err => {
        console.error('Lá»—i táº£i GeoJSON:', err);
        alert('KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u tá»« data/poi.geojson. Sá»­ dá»¥ng dá»¯ liá»‡u máº·c Ä‘á»‹nh Ä‘á»ƒ kiá»ƒm tra.\nVui lÃ²ng kiá»ƒm tra:\n- Äáº£m báº£o tá»‡p data/poi.geojson tá»“n táº¡i.\n- Kiá»ƒm tra cáº¥u trÃºc dá»¯ liá»‡u trong tá»‡p.');
        loadPlaces(defaultData);
      });

    // HÃ m táº£i vÃ  hiá»ƒn thá»‹ Ä‘á»‹a Ä‘iá»ƒm
    function loadPlaces(data) {
      const filterGroup = document.getElementById('filter-group');
      const types = new Set();

      // Thu tháº­p táº¥t cáº£ cÃ¡c loáº¡i Ä‘á»‹a Ä‘iá»ƒm
      data.features.forEach(feature => {
        if (feature.properties && feature.properties.type) {
          types.add(feature.properties.type);
        }
      });

      // Táº¡o nÃºt vÃ  danh sÃ¡ch cho tá»«ng loáº¡i
      types.forEach(type => {
        const button = document.createElement('button');
        button.innerHTML = `${typeEmojis[type] || typeEmojis['default']} ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        button.onclick = () => toggleType(type);
        filterGroup.appendChild(button);

        const subList = document.createElement('div');
        subList.id = `list-${type}`;
        subList.className = 'sub-list';
        subList.innerHTML = '<ul></ul>';
        filterGroup.appendChild(subList);
      });

      // Xá»­ lÃ½ tá»«ng Ä‘á»‹a Ä‘iá»ƒm
      data.features.forEach(feature => {
        if (!feature.geometry || !feature.geometry.coordinates || !feature.properties || !feature.properties.name || !feature.properties.type) {
          console.warn('Dá»¯ liá»‡u Ä‘á»‹a Ä‘iá»ƒm khÃ´ng Ä‘áº§y Ä‘á»§:', feature);
          return;
        }

        const type = feature.properties.type;
        const name = feature.properties.name;
        const desc = feature.properties.description || 'KhÃ´ng cÃ³ mÃ´ táº£';
        const image = feature.properties.image || 'https://via.placeholder.com/200'; // Chá»‰ kiá»ƒm tra náº¿u image tá»“n táº¡i, náº¿u khÃ´ng dÃ¹ng áº£nh máº·c Ä‘á»‹nh
        const coord = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
        const rating = feature.properties.rating || 'ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡';
        const address = feature.properties.address || 'KhÃ´ng cÃ³ Ä‘á»‹a chá»‰';
        const opening_hours = feature.properties.opening_hours || 'KhÃ´ng cÃ³ thÃ´ng tin giá» má»Ÿ cá»­a';
        const phone = feature.properties.phone || 'KhÃ´ng cÃ³ sá»‘ Ä‘iá»‡n thoáº¡i';
        const website = feature.properties.website || '';

        const marker = L.marker(coord, { icon: icons[type] || icons['default'] });
        marker.bindPopup(`
          <div class="popup-header">
            <img src="${image}" alt="${name}" class="popup-image">
          </div>
          <div class="popup-content">
            <h3 class="popup-title">${name}</h3>
            <div class="popup-rating">
              <span class="stars">${rating ? 'â˜…â˜…â˜…â˜…â˜…'.slice(0, Math.round(rating)) + 'â˜†â˜†â˜†â˜†â˜†'.slice(Math.round(rating)) : 'â˜†â˜†â˜†â˜†â˜†'}</span>
              ${rating || 'ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡'}
            </div>
            <div class="popup-address">${address}</div>
            <div class="popup-hours">${opening_hours}</div>
            <div class="popup-phone">${phone}</div>
            ${website ? `<div class="popup-website"><a href="${website}" target="_blank">${website}</a></div>` : ''}
            <p class="popup-description">${desc}</p>
            <div class="popup-buttons">
              <button class="navigate-btn" onclick="navigateTo(${coord[0]}, ${coord[1]}, '${name}')">Chá»‰ Ä‘Æ°á»ng</button>
              <button class="google-maps-btn" onclick="openInGoogleMaps(${coord[0]}, ${coord[1]})">Má»Ÿ Google Maps</button>
              <button class="favorite-btn" onclick="toggleFavorite('${name}', '${coord}', '${type}', '${image}', '${desc}')">
                ${favoritePlaces.includes(name) ? 'Bá» yÃªu thÃ­ch' : 'ThÃªm vÃ o yÃªu thÃ­ch'}
              </button>
            </div>
          </div>
        `).addTo(map);

        if (!markersByType[type]) markersByType[type] = [];
        markersByType[type].push(marker);
        allMarkers.push({ marker, name, type, coord, image, desc });
      });

      updateSidebarAndMarkers();
    }

    // HÃ m cáº­p nháº­t sidebar vÃ  marker
    function updateSidebarAndMarkers(searchText = '') {
      Object.keys(markersByType).forEach(type => {
        const container = document.getElementById('list-' + type);
        const ul = container.querySelector('ul');
        ul.innerHTML = '';
        container.style.display = 'none';
      });

      allMarkers.forEach(({ marker }) => {
        map.removeLayer(marker);
      });

      allMarkers.forEach(({ marker, name, type, coord }) => {
        const matchesSearch = searchText === '' || name.toLowerCase().includes(searchText.toLowerCase());
        const matchesType = activeType === null || type === activeType;

        if (matchesSearch && matchesType) {
          marker.addTo(map);

          const container = document.getElementById('list-' + type);
          if (container) {
            const ul = container.querySelector('ul');
            const li = document.createElement('li');
            li.textContent = name;
            li.onclick = () => {
              map.setView(coord, 16);
              marker.openPopup();
            };
            ul.appendChild(li);
            container.style.display = 'block';
          }
        }
      });
    }

    // HÃ m chuyá»ƒn Ä‘á»•i hiá»ƒn thá»‹ danh sÃ¡ch vÃ  marker theo loáº¡i
    function toggleType(type) {
      if (activeType === type) {
        activeType = null;
      } else {
        activeType = type;
      }
      updateSidebarAndMarkers(document.getElementById('search').value);
    }

    // TÃ¬m kiáº¿m Ä‘á»‹a Ä‘iá»ƒm
    document.getElementById('search').addEventListener('input', function(e) {
      const searchText = e.target.value.trim();
      updateSidebarAndMarkers(searchText);
    });

    // HÃ m dáº«n Ä‘Æ°á»ng sá»­ dá»¥ng OSRM
    function navigateTo(lat, lng, destinationName) {
      if (!currentLocation) {
        alert('KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­ hiá»‡n táº¡i. Vui lÃ²ng kiá»ƒm tra quyá»n Ä‘á»‹nh vá»‹.');
        return;
      }

      if (currentRoute) {
        map.removeLayer(currentRoute);
      }

      const osrmUrl = `http://router.project-osrm.org/route/v1/bike/${currentLocation[1]},${currentLocation[0]};${lng},${lat}?overview=full&geometries=geojson`;
      fetch(osrmUrl)
        .then(res => res.json())
        .then(data => {
          if (data.code === 'Ok') {
            const routeCoords = data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
            currentRoute = L.polyline(routeCoords, { color: 'blue', weight: 4 }).addTo(map);
            map.fitBounds(currentRoute.getBounds());
          } else {
            alert('KhÃ´ng thá»ƒ tÃ¬m tuyáº¿n Ä‘Æ°á»ng. Vui lÃ²ng thá»­ láº¡i hoáº·c má»Ÿ Google Maps.');
          }
        })
        .catch(err => {
          console.error('Lá»—i gá»i OSRM API:', err);
          alert('Lá»—i khi tÃ¬m tuyáº¿n Ä‘Æ°á»ng. Vui lÃ²ng má»Ÿ Google Maps Ä‘á»ƒ dáº«n Ä‘Æ°á»ng.');
        });
    }

    // HÃ m má»Ÿ Google Maps
    function openInGoogleMaps(lat, lng) {
      if (!currentLocation) {
        alert('KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­ hiá»‡n táº¡i. Vui lÃ²ng kiá»ƒm tra quyá»n Ä‘á»‹nh vá»‹.');
        return;
      }

      const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${currentLocation[0]},${currentLocation[1]}&destination=${lat},${lng}&travelmode=motorcycle`;
      window.open(googleMapsUrl, '_blank');
    }

    // HÃ m thÃªm/bá» yÃªu thÃ­ch
    function toggleFavorite(name, coord, type, image, desc) {
      if (favoritePlaces.includes(name)) {
        favoritePlaces = favoritePlaces.filter(place => place !== name);
      } else {
        favoritePlaces.push(name);
      }
      localStorage.setItem('favorites', JSON.stringify(favoritePlaces));

      allMarkers.forEach(({ marker: m, name: markerName }) => {
        if (markerName === name) {
          m.setPopupContent(`
            <div class="popup-header">
              <img src="${image}" alt="${name}" class="popup-image">
            </div>
            <div class="popup-content">
              <h3 class="popup-title">${name}</h3>
              <div class="popup-rating">
                <span class="stars">${m.rating ? 'â˜…â˜…â˜…â˜…â˜…'.slice(0, Math.round(m.rating)) + 'â˜†â˜†â˜†â˜†â˜†'.slice(Math.round(m.rating)) : 'â˜†â˜†â˜†â˜†â˜†'}</span>
                ${m.rating || 'ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡'}
              </div>
              <div class="popup-address">${m.address || 'KhÃ´ng cÃ³ Ä‘á»‹a chá»‰'}</div>
              <div class="popup-hours">${m.opening_hours || 'KhÃ´ng cÃ³ thÃ´ng tin giá» má»Ÿ cá»­a'}</div>
              <div class="popup-phone">${m.phone || 'KhÃ´ng cÃ³ sá»‘ Ä‘iá»‡n thoáº¡i'}</div>
              ${m.website ? `<div class="popup-website"><a href="${m.website}" target="_blank">${m.website}</a></div>` : ''}
              <p class="popup-description">${desc}</p>
              <div class="popup-buttons">
                <button class="navigate-btn" onclick="navigateTo(${coord.split(',')[0]}, ${coord.split(',')[1]}, '${name}')">Chá»‰ Ä‘Æ°á»ng</button>
                <button class="google-maps-btn" onclick="openInGoogleMaps(${coord.split(',')[0]}, ${coord.split(',')[1]})">Má»Ÿ Google Maps</button>
                <button class="favorite-btn" onclick="toggleFavorite('${name}', '${coord}', '${type}', '${image}', '${desc}')">
                  ${favoritePlaces.includes(name) ? 'Bá» yÃªu thÃ­ch' : 'ThÃªm vÃ o yÃªu thÃ­ch'}
                </button>
              </div>
            </div>
          `);
        }
      });

      updateSidebarAndMarkers(document.getElementById('search').value);
    }
  </script>
</body>
</html>