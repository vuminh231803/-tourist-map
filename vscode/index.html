<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hà Nội - Bản đồ du lịch</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="sidebar">
    <h2>📍 Bản đồ Hà Nội</h2>
    <div class="search-container">
      <input type="text" id="search" class="search-input" placeholder="Tìm địa điểm...">
      <span class="search-icon">🔍</span>
    </div>
    <div class="filter-group" id="filter-group">
      <!-- Danh sách loại địa điểm sẽ được tạo động -->
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Khởi tạo bản đồ
    const map = L.map('map').setView([21.0285, 105.8542], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // Lưu trữ marker và dữ liệu
    let markersByType = {};
    let allMarkers = [];
    let currentLocation = null;
    let currentRoute = null;
    let favoritePlaces = JSON.parse(localStorage.getItem('favorites')) || [];
    let activeType = null;

    // Biểu tượng tùy chỉnh cho từng loại địa điểm
    const icons = {
      'chùa': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/306/306342.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'nhà thờ': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/188/188124.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'bảo tàng': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/167/167707.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'công viên': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/293/293117.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'trung tâm thương mại': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/308/308285.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'default': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/149/149060.png', iconSize: [32, 32], iconAnchor: [16, 32] })
    };

    // Emoji cho từng loại địa điểm
    const typeEmojis = {
      'chùa': '🛕',
      'nhà thờ': '⛪',
      'bảo tàng': '🏛️',
      'công viên': '🌳',
      'trung tâm thương mại': '🛍️',
      'hồ': '🌊',
      'di tích': '🏯',
      'cầu': '🌉',
      'khu phố': '🏘️',
      'kiến trúc': '🏛️',
      'làng nghề': '🛠️',
      'đền': '⛩️',
      'chợ': '🛒',
      'khu vui chơi': '🎢',
      'cao ốc': '🏙️',
      'trung tâm hội nghị': '🏛️',
      'trường đại học': '🎓',
      'khu đô thị': '🏬',
      'sân vận động': '🏟️',
      'đường phố': '🛣️',
      'ga tàu': '🚂',
      'default': '📍'
    };

    // Lấy vị trí hiện tại của người dùng
    navigator.geolocation.getCurrentPosition(
      (position) => {
        currentLocation = [position.coords.latitude, position.coords.longitude];
        L.marker(currentLocation, { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/684/684908.png', iconSize: [32, 32], iconAnchor: [16, 32] }) })
          .bindPopup('Vị trí của bạn')
          .addTo(map);
        map.setView(currentLocation, 13);
      },
      (error) => {
        console.error('Lỗi lấy vị trí:', error);
        alert('Không thể lấy vị trí của bạn. Vui lòng bật định vị hoặc kiểm tra quyền truy cập.');
      }
    );

    // Dữ liệu mặc định nếu không tải được poi.geojson
    const defaultData = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "geometry": {
            "type": "Point",
            "coordinates": [105.8542, 21.0285]
          },
          "properties": {
            "name": "Chùa Một Cột",
            "description": "Ngôi chùa nổi tiếng ở Hà Nội",
            "type": "chùa",
            "image": "image/chuamotcot.jpg",
            "rating": 4.5,
            "address": "Đội Cấn, Ba Đình, Hà Nội",
            "opening_hours": "Mở cửa: 07:00 - 18:00",
            "phone": "+84 24 3825 1234",
            "website": "http://chuamotcot.vn"
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Point",
            "coordinates": [105.852, 21.030]
          },
          "properties": {
            "name": "Nhà thờ Lớn",
            "description": "Nhà thờ Công giáo nổi bật",
            "type": "nhà thờ",
            "image": "image/nhatholon.jpg",
            "rating": 4.3,
            "address": "40 Nhà Chung, Hàng Trống, Hoàn Kiếm, Hà Nội",
            "opening_hours": "Mở cửa: 08:00 - 20:00",
            "phone": "+84 24 3828 4567",
            "website": "http://nhatholonhanoi.vn"
          }
        }
      ]
    };

    // Tải dữ liệu GeoJSON
    fetch('data/poi.geojson')
      .then(res => {
        console.log('Trạng thái phản hồi:', res.status, res.statusText);
        if (!res.ok) throw new Error('Không thể tải GeoJSON: ' + res.statusText);
        return res.json();
      })
      .then(data => {
        console.log('Dữ liệu GeoJSON:', data);
        if (!data.features || !Array.isArray(data.features)) {
          throw new Error('Dữ liệu GeoJSON không đúng định dạng');
        }
        loadPlaces(data);
      })
      .catch(err => {
        console.error('Lỗi tải GeoJSON:', err);
        alert('Không thể tải dữ liệu từ data/poi.geojson. Sử dụng dữ liệu mặc định để kiểm tra.\nVui lòng kiểm tra:\n- Đảm bảo tệp data/poi.geojson tồn tại.\n- Kiểm tra cấu trúc dữ liệu trong tệp.');
        loadPlaces(defaultData);
      });

    // Hàm tải và hiển thị địa điểm
    function loadPlaces(data) {
      const filterGroup = document.getElementById('filter-group');
      const types = new Set();

      // Thu thập tất cả các loại địa điểm
      data.features.forEach(feature => {
        if (feature.properties && feature.properties.type) {
          types.add(feature.properties.type);
        }
      });

      // Tạo nút và danh sách cho từng loại
      types.forEach(type => {
        const button = document.createElement('button');
        button.innerHTML = `${typeEmojis[type] || typeEmojis['default']} ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        button.onclick = () => toggleType(type);
        filterGroup.appendChild(button);

        const subList = document.createElement('div');
        subList.id = `list-${type}`;
        subList.className = 'sub-list';
        subList.innerHTML = '<ul></ul>';
        filterGroup.appendChild(subList);
      });

      // Xử lý từng địa điểm
      data.features.forEach(feature => {
        if (!feature.geometry || !feature.geometry.coordinates || !feature.properties || !feature.properties.name || !feature.properties.type) {
          console.warn('Dữ liệu địa điểm không đầy đủ:', feature);
          return;
        }

        const type = feature.properties.type;
        const name = feature.properties.name;
        const desc = feature.properties.description || 'Không có mô tả';
        const image = feature.properties.image || 'https://via.placeholder.com/200'; // Chỉ kiểm tra nếu image tồn tại, nếu không dùng ảnh mặc định
        const coord = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
        const rating = feature.properties.rating || 'Chưa có đánh giá';
        const address = feature.properties.address || 'Không có địa chỉ';
        const opening_hours = feature.properties.opening_hours || 'Không có thông tin giờ mở cửa';
        const phone = feature.properties.phone || 'Không có số điện thoại';
        const website = feature.properties.website || '';

        const marker = L.marker(coord, { icon: icons[type] || icons['default'] });
        marker.bindPopup(`
          <div class="popup-header">
            <img src="${image}" alt="${name}" class="popup-image">
          </div>
          <div class="popup-content">
            <h3 class="popup-title">${name}</h3>
            <div class="popup-rating">
              <span class="stars">${rating ? '★★★★★'.slice(0, Math.round(rating)) + '☆☆☆☆☆'.slice(Math.round(rating)) : '☆☆☆☆☆'}</span>
              ${rating || 'Chưa có đánh giá'}
            </div>
            <div class="popup-address">${address}</div>
            <div class="popup-hours">${opening_hours}</div>
            <div class="popup-phone">${phone}</div>
            ${website ? `<div class="popup-website"><a href="${website}" target="_blank">${website}</a></div>` : ''}
            <p class="popup-description">${desc}</p>
            <div class="popup-buttons">
              <button class="navigate-btn" onclick="navigateTo(${coord[0]}, ${coord[1]}, '${name}')">Chỉ đường</button>
              <button class="google-maps-btn" onclick="openInGoogleMaps(${coord[0]}, ${coord[1]})">Mở Google Maps</button>
              <button class="favorite-btn" onclick="toggleFavorite('${name}', '${coord}', '${type}', '${image}', '${desc}')">
                ${favoritePlaces.includes(name) ? 'Bỏ yêu thích' : 'Thêm vào yêu thích'}
              </button>
            </div>
          </div>
        `).addTo(map);

        if (!markersByType[type]) markersByType[type] = [];
        markersByType[type].push(marker);
        allMarkers.push({ marker, name, type, coord, image, desc });
      });

      updateSidebarAndMarkers();
    }

    // Hàm cập nhật sidebar và marker
    function updateSidebarAndMarkers(searchText = '') {
      Object.keys(markersByType).forEach(type => {
        const container = document.getElementById('list-' + type);
        const ul = container.querySelector('ul');
        ul.innerHTML = '';
        container.style.display = 'none';
      });

      allMarkers.forEach(({ marker }) => {
        map.removeLayer(marker);
      });

      allMarkers.forEach(({ marker, name, type, coord }) => {
        const matchesSearch = searchText === '' || name.toLowerCase().includes(searchText.toLowerCase());
        const matchesType = activeType === null || type === activeType;

        if (matchesSearch && matchesType) {
          marker.addTo(map);

          const container = document.getElementById('list-' + type);
          if (container) {
            const ul = container.querySelector('ul');
            const li = document.createElement('li');
            li.textContent = name;
            li.onclick = () => {
              map.setView(coord, 16);
              marker.openPopup();
            };
            ul.appendChild(li);
            container.style.display = 'block';
          }
        }
      });
    }

    // Hàm chuyển đổi hiển thị danh sách và marker theo loại
    function toggleType(type) {
      if (activeType === type) {
        activeType = null;
      } else {
        activeType = type;
      }
      updateSidebarAndMarkers(document.getElementById('search').value);
    }

    // Tìm kiếm địa điểm
    document.getElementById('search').addEventListener('input', function(e) {
      const searchText = e.target.value.trim();
      updateSidebarAndMarkers(searchText);
    });

    // Hàm dẫn đường sử dụng OSRM
    function navigateTo(lat, lng, destinationName) {
      if (!currentLocation) {
        alert('Không thể lấy vị trí hiện tại. Vui lòng kiểm tra quyền định vị.');
        return;
      }

      if (currentRoute) {
        map.removeLayer(currentRoute);
      }

      const osrmUrl = `http://router.project-osrm.org/route/v1/bike/${currentLocation[1]},${currentLocation[0]};${lng},${lat}?overview=full&geometries=geojson`;
      fetch(osrmUrl)
        .then(res => res.json())
        .then(data => {
          if (data.code === 'Ok') {
            const routeCoords = data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
            currentRoute = L.polyline(routeCoords, { color: 'blue', weight: 4 }).addTo(map);
            map.fitBounds(currentRoute.getBounds());
          } else {
            alert('Không thể tìm tuyến đường. Vui lòng thử lại hoặc mở Google Maps.');
          }
        })
        .catch(err => {
          console.error('Lỗi gọi OSRM API:', err);
          alert('Lỗi khi tìm tuyến đường. Vui lòng mở Google Maps để dẫn đường.');
        });
    }

    // Hàm mở Google Maps
    function openInGoogleMaps(lat, lng) {
      if (!currentLocation) {
        alert('Không thể lấy vị trí hiện tại. Vui lòng kiểm tra quyền định vị.');
        return;
      }

      const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${currentLocation[0]},${currentLocation[1]}&destination=${lat},${lng}&travelmode=motorcycle`;
      window.open(googleMapsUrl, '_blank');
    }

    // Hàm thêm/bỏ yêu thích
    function toggleFavorite(name, coord, type, image, desc) {
      if (favoritePlaces.includes(name)) {
        favoritePlaces = favoritePlaces.filter(place => place !== name);
      } else {
        favoritePlaces.push(name);
      }
      localStorage.setItem('favorites', JSON.stringify(favoritePlaces));

      allMarkers.forEach(({ marker: m, name: markerName }) => {
        if (markerName === name) {
          m.setPopupContent(`
            <div class="popup-header">
              <img src="${image}" alt="${name}" class="popup-image">
            </div>
            <div class="popup-content">
              <h3 class="popup-title">${name}</h3>
              <div class="popup-rating">
                <span class="stars">${m.rating ? '★★★★★'.slice(0, Math.round(m.rating)) + '☆☆☆☆☆'.slice(Math.round(m.rating)) : '☆☆☆☆☆'}</span>
                ${m.rating || 'Chưa có đánh giá'}
              </div>
              <div class="popup-address">${m.address || 'Không có địa chỉ'}</div>
              <div class="popup-hours">${m.opening_hours || 'Không có thông tin giờ mở cửa'}</div>
              <div class="popup-phone">${m.phone || 'Không có số điện thoại'}</div>
              ${m.website ? `<div class="popup-website"><a href="${m.website}" target="_blank">${m.website}</a></div>` : ''}
              <p class="popup-description">${desc}</p>
              <div class="popup-buttons">
                <button class="navigate-btn" onclick="navigateTo(${coord.split(',')[0]}, ${coord.split(',')[1]}, '${name}')">Chỉ đường</button>
                <button class="google-maps-btn" onclick="openInGoogleMaps(${coord.split(',')[0]}, ${coord.split(',')[1]})">Mở Google Maps</button>
                <button class="favorite-btn" onclick="toggleFavorite('${name}', '${coord}', '${type}', '${image}', '${desc}')">
                  ${favoritePlaces.includes(name) ? 'Bỏ yêu thích' : 'Thêm vào yêu thích'}
                </button>
              </div>
            </div>
          `);
        }
      });

      updateSidebarAndMarkers(document.getElementById('search').value);
    }
  </script>
</body>
</html>