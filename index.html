<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HÃ  Ná»™i - Báº£n Ä‘á»“ du lá»‹ch</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="sidebar">
    <h2>ğŸ“ Báº£n Ä‘á»“ HÃ  Ná»™i</h2>
    <div id="weather-info" class="weather-info">
      <img src="https://openweathermap.org/img/wn/01d.png" alt="Thá»i tiáº¿t">
      <div>
        <strong>HÃ  Ná»™i:</strong> 28Â°C, Trá»i quang
      </div>
    </div>
    <div class="search-container">
      <input type="text" id="search" class="search-input" placeholder="TÃ¬m Ä‘á»‹a Ä‘iá»ƒm...">
      <span class="search-icon">ğŸ”</span>
    </div>
    <button id="dark-mode-toggle">ğŸŒ™ Cháº¿ Ä‘á»™ tá»‘i</button>
    <button id="near-me-btn">TÃ¬m gáº§n tÃ´i</button>
    <div class="filter-group" id="filter-group">
      <!-- Danh sÃ¡ch loáº¡i Ä‘á»‹a Ä‘iá»ƒm -->
    </div>

    <!-- NÃºt má»Ÿ form thÃªm Ä‘á»‹a Ä‘iá»ƒm -->
    <button onclick="document.getElementById('form-container').style.display='block'">ThÃªm Ä‘á»‹a Ä‘iá»ƒm</button>

    <!-- Báº£ng danh sÃ¡ch Ä‘á»‹a Ä‘iá»ƒm -->
    <table id="places-table">
      <thead>
        <tr>
          <th>TÃªn</th>
          <th>Äá»‹a chá»‰</th>
          <th>HÃ nh Ä‘á»™ng</th>
        </tr>
      </thead>
      <tbody id="places-table-body"></tbody>
    </table>

    <!-- Form thÃªm/sá»­a Ä‘á»‹a Ä‘iá»ƒm -->
    <div id="form-container">
      <h3 id="form-title">ThÃªm Ä‘á»‹a Ä‘iá»ƒm má»›i</h3>
      <form id="place-form" enctype="multipart/form-data">
        <label for="name">TÃªn:</label>
        <input type="text" id="name" required>
        <label for="latitude">VÄ© Ä‘á»™:</label>
        <input type="number" id="latitude" step="any" required>
        <label for="longitude">Kinh Ä‘á»™:</label>
        <input type="number" id="longitude" step="any" required>
        <label for="type">Danh má»¥c:</label>
        <select id="type" required>
          <option value="chÃ¹a">ChÃ¹a</option>
          <option value="nhÃ  thá»">NhÃ  thá»</option>
          <option value="báº£o tÃ ng">Báº£o tÃ ng</option>
          <option value="cÃ´ng viÃªn">CÃ´ng viÃªn</option>
          <option value="trung tÃ¢m thÆ°Æ¡ng máº¡i">Trung tÃ¢m thÆ°Æ¡ng máº¡i</option>
        </select>
        <label for="address">Äá»‹a chá»‰:</label>
        <input type="text" id="address">
        <label for="description">MÃ´ táº£:</label>
        <textarea id="description"></textarea>

        <label for="phone">Sá»‘ Ä‘iá»‡n thoáº¡i:</label>
        <input type="text" id="phone">

        <label for="opening_hours">Giá» má»Ÿ cá»­a:</label>
        <input type="text" id="opening_hours">

        <label for="website">Website:</label>
        <input type="url" id="website">

        <label for="image">Táº£i lÃªn hÃ¬nh áº£nh:</label>
        <input type="file" id="image" accept="image/*">
        <button type="submit">LÆ°u</button>
        <button type="button" id="cancel-btn">Há»§y</button>
      </form>
    </div>
  </div>  

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Khá»Ÿi táº¡o báº£n Ä‘á»“
    const map = L.map('map').setView([21.0285, 105.8542], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // API URL
    const apiUrl = 'http://localhost:3001/api/places';

    // LÆ°u trá»¯ marker vÃ  dá»¯ liá»‡u
    let markersByType = {};
    let allMarkers = [];
    let currentLocation = null;
    let currentRoute = null;
    let favoritePlaces = JSON.parse(localStorage.getItem('favorites')) || [];
    let placeRatings = JSON.parse(localStorage.getItem('placeRatings')) || {};
    let activeType = null;

    // Biá»ƒu tÆ°á»£ng tÃ¹y chá»‰nh cho tá»«ng loáº¡i Ä‘á»‹a Ä‘iá»ƒm
    const icons = {
      'chÃ¹a': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/306/306342.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'nhÃ  thá»': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/188/188124.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'báº£o tÃ ng': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/167/167707.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'cÃ´ng viÃªn': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/293/293117.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'trung tÃ¢m thÆ°Æ¡ng máº¡i': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/308/308285.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      'default': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/149/149060.png', iconSize: [32, 32], iconAnchor: [16, 32] })
    };

    // Emoji cho tá»«ng loáº¡i Ä‘á»‹a Ä‘iá»ƒm
    const typeEmojis = {
      'chÃ¹a': 'ğŸ›•',
      'nhÃ  thá»': 'â›ª',
      'báº£o tÃ ng': 'ğŸ›ï¸',
      'cÃ´ng viÃªn': 'ğŸŒ³',
      'trung tÃ¢m thÆ°Æ¡ng máº¡i': 'ğŸ›ï¸',
      'default': 'ğŸ“'
    };

    // HÃ m chuyá»ƒn Ä‘á»•i tá»a Ä‘á»™ tá»« ST_AsText (POINT(long lat)) sang [lat, long]
    function parseCoordinates(coordinates) {
      const matches = coordinates.match(/POINT\(([^ ]+) ([^ ]+)\)/);
      if (matches) return [parseFloat(matches[2]), parseFloat(matches[1])];
      return [0, 0];
    }

    // Láº¥y vá»‹ trÃ­ hiá»‡n táº¡i cá»§a ngÆ°á»i dÃ¹ng
    function requestLocation() {
      if (confirm('á»¨ng dá»¥ng muá»‘n truy cáº­p vá»‹ trÃ­ cá»§a báº¡n Ä‘á»ƒ hiá»ƒn thá»‹ vá»‹ trÃ­ hiá»‡n táº¡i vÃ  tÃ¬m Ä‘á»‹a Ä‘iá»ƒm gáº§n báº¡n. Báº¡n cÃ³ Ä‘á»“ng Ã½ khÃ´ng?')) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            currentLocation = [position.coords.latitude, position.coords.longitude];
            L.marker(currentLocation, { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/684/684908.png', iconSize: [32, 32], iconAnchor: [16, 32] }) })
              .bindPopup('Vá»‹ trÃ­ cá»§a báº¡n')
              .addTo(map);
            map.setView(currentLocation, 13);
          },
          (error) => {
            console.error('Lá»—i láº¥y vá»‹ trÃ­:', error);
            alert('KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­ cá»§a báº¡n. Vui lÃ²ng báº­t Ä‘á»‹nh vá»‹ hoáº·c kiá»ƒm tra quyá»n truy cáº­p.');
          }
        );
      } else {
        alert('Báº¡n Ä‘Ã£ tá»« chá»‘i cung cáº¥p vá»‹ trÃ­. Má»™t sá»‘ tÃ­nh nÄƒng nhÆ° "TÃ¬m gáº§n tÃ´i" sáº½ khÃ´ng hoáº¡t Ä‘á»™ng.');
      }
    }

    // HÃ m tÃ­nh khoáº£ng cÃ¡ch Haversine
    function haversineDistance(coords1, coords2) {
      const R = 6371;
      const dLat = (coords2[0] - coords1[0]) * Math.PI / 180;
      const dLon = (coords2[1] - coords1[1]) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(coords1[0] * Math.PI / 180) * Math.cos(coords2[0] * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // HÃ m táº£i dá»¯ liá»‡u tá»« API
    async function loadPlaces() {
      try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        console.log('Dá»¯ liá»‡u Ä‘á»‹a Ä‘iá»ƒm:', data);

        if (!Array.isArray(data) || data.length === 0) {
          console.warn('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»‹a Ä‘iá»ƒm tá»« API');
          alert('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»‹a Ä‘iá»ƒm. Vui lÃ²ng kiá»ƒm tra cÆ¡ sá»Ÿ dá»¯ liá»‡u.');
          return;
        }

        const filterGroup = document.getElementById('filter-group');
        const types = new Set();

        // Thu tháº­p cÃ¡c loáº¡i Ä‘á»‹a Ä‘iá»ƒm
        data.forEach(place => {
          if (place.type) types.add(place.type);
        });

        // Táº¡o nÃºt lá»c vÃ  danh sÃ¡ch con cho tá»«ng loáº¡i
        types.forEach(type => {
          const button = document.createElement('button');
          button.innerHTML = `${typeEmojis[type] || typeEmojis['default']} ${type.charAt(0).toUpperCase() + type.slice(1)}`;
          button.onclick = () => toggleType(type);
          filterGroup.appendChild(button);

          const subList = document.createElement('div');
          subList.id = `list-${type}`;
          subList.className = 'sub-list';
          subList.innerHTML = '<ul></ul>';
          filterGroup.appendChild(subList);
        });

        // Xá»­ lÃ½ tá»«ng Ä‘á»‹a Ä‘iá»ƒm
        data.forEach(place => {
          if (!place.coordinates || !place.name || !place.type) {
            console.warn('Dá»¯ liá»‡u Ä‘á»‹a Ä‘iá»ƒm khÃ´ng Ä‘áº§y Ä‘á»§:', place);
            return;
          }

          const type = place.type;
          const name = place.name;
          const desc = place.description || 'KhÃ´ng cÃ³ mÃ´ táº£'; // Sá»­ dá»¥ng description náº¿u cÃ³ trong API
          const image = place.image || 'https://via.placeholder.com/300x150'; // Fallback náº¿u khÃ´ng cÃ³ áº£nh
          const coord = parseCoordinates(place.coordinates);
          const rating = placeRatings[name] || 'ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡';
          const address = place.address || 'KhÃ´ng cÃ³ Ä‘á»‹a chá»‰';
          const opening_hours = place.opening_hours || 'KhÃ´ng cÃ³ thÃ´ng tin giá» má»Ÿ cá»­a'; // ThÃªm náº¿u API cÃ³
          const phone = place.phone || 'KhÃ´ng cÃ³ sá»‘ Ä‘iá»‡n thoáº¡i'; // ThÃªm náº¿u API cÃ³
          const website = place.website || ''; // ThÃªm náº¿u API cÃ³
          const ogc_fid = place.ogc_fid; // LÆ°u ogc_fid Ä‘á»ƒ sá»­ dá»¥ng cho CRUD

          const marker = L.marker(coord, { icon: icons[type] || icons['default'] });
          marker.bindPopup(`
            <div class="leaflet-popup-content-wrapper">
              <div class="popup-header">
                <img src="${image}" alt="${name}" class="popup-image" loading="lazy">
              </div>
              <div class="popup-content">
                <h3 class="popup-title">${name}</h3>
                <div class="popup-rating">
                  <span class="stars">${rating !== 'ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡' ? 'â˜…â˜…â˜…â˜…â˜…'.slice(0, rating === 'ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡' ? 0 : Math.round(rating)) + 'â˜†â˜†â˜†â˜†â˜†'.slice(rating === 'ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡' ? 0 : Math.round(rating)) : 'â˜†â˜†â˜†â˜†â˜†'}</span>
                  ${rating}
                </div>
                <div class="popup-address">${address}</div>
                <div class="popup-hours">${opening_hours}</div>
                <div class="popup-phone">${phone}</div>
                ${website ? `<div class="popup-website"><a href="${website}" target="_blank">${website}</a></div>` : ''}
                <p class="popup-description">${desc}</p>
                <div class="popup-rating-input">
                  <label>ÄÃ¡nh giÃ¡ cá»§a báº¡n:</label>
                  <select onchange="ratePlace('${name}', this.value)">
                    <option value="">Chá»n sá»‘ sao</option>
                    <option value="1">1 sao</option>
                    <option value="2">2 sao</option>
                    <option value="3">3 sao</option>
                    <option value="4">4 sao</option>
                    <option value="5">5 sao</option>
                  </select>
                </div>
                <div class="popup-buttons">
                  <button class="navigate-btn" onclick="navigateTo(${coord[0]}, ${coord[1]}, '${name}')">Chá»‰ Ä‘Æ°á»ng</button>
                  <button class="favorite-btn" onclick="toggleFavorite('${name}', '${coord}', '${type}', '${image}', '${desc}')">
                    ${favoritePlaces.includes(name) ? 'Bá» yÃªu thÃ­ch' : 'ThÃªm vÃ o yÃªu thÃ­ch'}
                  </button>
                </div>
              </div>
            </div>
          `).addTo(map);

          marker.address = address;
          marker.opening_hours = opening_hours;
          marker.phone = phone;
          marker.website = website;
          marker.rating = rating;
          marker.ogc_fid = ogc_fid;

          if (!markersByType[type]) markersByType[type] = [];
          markersByType[type].push(marker);
          allMarkers.push({ marker, name, type, coord, image, desc });
        });

        updateSidebarAndMarkers();
        updatePlacesTable(); // Cáº­p nháº­t báº£ng
      } catch (error) {
        console.error('Lá»—i táº£i dá»¯ liá»‡u:', error);
        alert('KhÃ´ng thá»ƒ táº£i Ä‘á»‹a Ä‘iá»ƒm. Vui lÃ²ng kiá»ƒm tra server.');
      }
    }

    // HÃ m cáº­p nháº­t sidebar vÃ  marker
    function updateSidebarAndMarkers(searchText = '') {
      Object.keys(markersByType).forEach(type => {
        const container = document.getElementById('list-' + type);
        const ul = container.querySelector('ul');
        ul.innerHTML = '';
        container.style.display = 'none';
      });

      allMarkers.forEach(({ marker }) => {
        map.removeLayer(marker);
      });

      allMarkers.forEach(({ marker, name, type, coord }) => {
        const matchesSearch = searchText === '' || name.toLowerCase().includes(searchText.toLowerCase());
        const matchesType = activeType === null || type === activeType;

        if (matchesSearch && matchesType) {
          marker.addTo(map);

          const container = document.getElementById('list-' + type);
          if (container) {
            const ul = container.querySelector('ul');
            const li = document.createElement('li');
            li.textContent = name;
            li.onclick = () => {
              map.setView(coord, 16);
              marker.openPopup();
            };
            ul.appendChild(li);
            container.style.display = 'block';
          }
        }
      });
    }

    // HÃ m cáº­p nháº­t báº£ng danh sÃ¡ch Ä‘á»‹a Ä‘iá»ƒm
    function updatePlacesTable() {
      const tableBody = document.getElementById('places-table-body');
      tableBody.innerHTML = '';
      allMarkers.forEach(({ marker, name, type }) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${name}</td>
          <td>${marker.address || 'ChÆ°a cÃ³'}</td>
          <td>
            <button onclick="editPlace(${marker.ogc_fid})">Sá»­a</button>
            <button onclick="deletePlace(${marker.ogc_fid})">XÃ³a</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    // HÃ m chuyá»ƒn Ä‘á»•i hiá»ƒn thá»‹ danh sÃ¡ch vÃ  marker theo loáº¡i
    function toggleType(type) {
      if (activeType === type) {
        activeType = null;
      } else {
        activeType = type;
      }
      updateSidebarAndMarkers(document.getElementById('search').value);
    }

    // TÃ¬m kiáº¿m Ä‘á»‹a Ä‘iá»ƒm
    document.getElementById('search').addEventListener('input', function(e) {
      const searchText = e.target.value.trim();
      updateSidebarAndMarkers(searchText);
    });

    // ThÃªm sá»± kiá»‡n cho nÃºt "TÃ¬m gáº§n tÃ´i"
    document.getElementById('near-me-btn').addEventListener('click', function() {
      if (!currentLocation) {
        alert('Vui lÃ²ng cho phÃ©p truy cáº­p vá»‹ trÃ­ Ä‘á»ƒ sá»­ dá»¥ng tÃ­nh nÄƒng nÃ y.');
        return;
      }

      const nearbyPlaces = allMarkers.map(marker => {
        const distance = haversineDistance(currentLocation, marker.coord);
        return { ...marker, distance };
      });

      nearbyPlaces.sort((a, b) => a.distance - b.distance);
      const topNearby = nearbyPlaces.slice(0, 5);

      const nearMeList = document.createElement('div');
      nearMeList.id = 'near-me-list';
      nearMeList.className = 'near-me-container';
      nearMeList.innerHTML = '<h3>Gáº§n báº¡n nháº¥t</h3><ul></ul>';
      const ul = nearMeList.querySelector('ul');
      topNearby.forEach(place => {
        const li = document.createElement('li');
        li.className = 'near-me-item';
        li.innerHTML = `
          <img src="${place.image || 'https://via.placeholder.com/40'}" alt="${place.name}">
          <div>
            <strong>${place.name}</strong><br>
            ${place.type.charAt(0).toUpperCase() + place.type.slice(1)} (${place.distance.toFixed(2)} km)
          </div>
        `;
        li.onclick = () => {
          map.setView(place.coord, 16);
          place.marker.openPopup();
        };
        ul.appendChild(li);
      });

      const existingList = document.getElementById('near-me-list');
      if (existingList) existingList.remove();
      const nearMeBtn = document.getElementById('near-me-btn');
      nearMeBtn.insertAdjacentElement('afterend', nearMeList);
    });

    // ThÃªm sá»± kiá»‡n cho nÃºt dark mode
    document.getElementById('dark-mode-toggle').addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      const isDarkMode = document.body.classList.contains('dark-mode');
      this.textContent = isDarkMode ? 'â˜€ï¸ Cháº¿ Ä‘á»™ sÃ¡ng' : 'ğŸŒ™ Cháº¿ Ä‘á»™ tá»‘i';
    });

    // HÃ m dáº«n Ä‘Æ°á»ng sá»­ dá»¥ng OSRM
    function navigateTo(lat, lng, destinationName) {
      if (!currentLocation) {
        alert('KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­ hiá»‡n táº¡i. Vui lÃ²ng kiá»ƒm tra quyá»n Ä‘á»‹nh vá»‹.');
        return;
      }

      if (currentRoute) {
        map.removeLayer(currentRoute);
      }

      const osrmUrl = `http://router.project-osrm.org/route/v1/bike/${currentLocation[1]},${currentLocation[0]};${lng},${lat}?overview=full&geometries=geojson`;
      fetch(osrmUrl)
        .then(res => res.json())
        .then(data => {
          if (data.code === 'Ok') {
            const routeCoords = data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
            currentRoute = L.polyline(routeCoords, { color: 'blue', weight: 4 }).addTo(map);
            map.fitBounds(currentRoute.getBounds());
          } else {
            alert('KhÃ´ng thá»ƒ tÃ¬m tuyáº¿n Ä‘Æ°á»ng. Vui lÃ²ng thá»­ láº¡i.');
          }
        })
        .catch(err => {
          console.error('Lá»—i gá»i OSRM API:', err);
          alert('Lá»—i khi tÃ¬m tuyáº¿n Ä‘Æ°á»ng. Vui lÃ²ng thá»­ láº¡i.');
        });
    }

    // HÃ m xá»­ lÃ½ Ä‘Ã¡nh giÃ¡
    function ratePlace(name, rating) {
      placeRatings[name] = rating;
      localStorage.setItem('placeRatings', JSON.stringify(placeRatings));
      updatePopup(name);
    }

    // HÃ m cáº­p nháº­t popup sau khi Ä‘Ã¡nh giÃ¡
    function updatePopup(name) {
      allMarkers.forEach(({ marker, name: markerName, coord, type, image, desc }) => {
        if (markerName === name) {
          const rating = placeRatings[name] || marker.rating || 'ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡';
          marker.setPopupContent(`
            <div class="leaflet-popup-content-wrapper">
              <div class="popup-header">
                <img src="${image}" alt="${name}" class="popup-image" loading="lazy">
              </div>
              <div class="popup-content">
                <h3 class="popup-title">${name}</h3>
                <div class="popup-rating">
                  <span class="stars">${rating !== 'ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡' ? 'â˜…â˜…â˜…â˜…â˜…'.slice(0, rating === 'ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡' ? 0 : Math.round(rating)) + 'â˜†â˜†â˜†â˜†â˜†'.slice(rating === 'ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡' ? 0 : Math.round(rating)) : 'â˜†â˜†â˜†â˜†â˜†'}</span>
                  ${rating}
                </div>
                <div class="popup-address">${marker.address || 'KhÃ´ng cÃ³ Ä‘á»‹a chá»‰'}</div>
                <div class="popup-hours">${marker.opening_hours || 'KhÃ´ng cÃ³ thÃ´ng tin giá» má»Ÿ cá»­a'}</div>
                <div class="popup-phone">${marker.phone || 'KhÃ´ng cÃ³ sá»‘ Ä‘iá»‡n thoáº¡i'}</div>
                ${marker.website ? `<div class="popup-website"><a href="${marker.website}" target="_blank">${marker.website}</a></div>` : ''}
                <p class="popup-description">${desc}</p>
                <div class="popup-rating-input">
                  <label>ÄÃ¡nh giÃ¡ cá»§a báº¡n:</label>
                  <select onchange="ratePlace('${name}', this.value)">
                    <option value="">Chá»n sá»‘ sao</option>
                    <option value="1">1 sao</option>
                    <option value="2">2 sao</option>
                    <option value="3">3 sao</option>
                    <option value="4">4 sao</option>
                    <option value="5">5 sao</option>
                  </select>
                </div>
                <div class="popup-buttons">
                  <button class="navigate-btn" onclick="navigateTo(${coord[0]}, ${coord[1]}, '${name}')">Chá»‰ Ä‘Æ°á»ng</button>
                  <button class="favorite-btn" onclick="toggleFavorite('${name}', '${coord}', '${type}', '${image}', '${desc}')">
                    ${favoritePlaces.includes(name) ? 'Bá» yÃªu thÃ­ch' : 'ThÃªm vÃ o yÃªu thÃ­ch'}
                  </button>
                </div>
              </div>
            </div>
          `);
        }
      });
    }

    // HÃ m thÃªm/bá» yÃªu thÃ­ch
    function toggleFavorite(name, coord, type, image, desc) {
      if (favoritePlaces.includes(name)) {
        favoritePlaces = favoritePlaces.filter(place => place !== name);
      } else {
        favoritePlaces.push(name);
      }
      localStorage.setItem('favorites', JSON.stringify(favoritePlaces));

      allMarkers.forEach(({ marker: m, name: markerName }) => {
        if (markerName === name) {
          m.setPopupContent(`
            <div class="leaflet-popup-content-wrapper">
              <div class="popup-header">
                <img src="${image}" alt="${name}" class="popup-image" loading="lazy">
              </div>
              <div class="popup-content">
                <h3 class="popup-title">${name}</h3>
                <div class="popup-rating">
                  <span class="stars">${m.rating ? 'â˜…â˜…â˜…â˜…â˜…'.slice(0, Math.round(m.rating)) + 'â˜†â˜†â˜†â˜†â˜†'.slice(Math.round(m.rating)) : 'â˜†â˜†â˜†â˜†â˜†'}</span>
                  ${m.rating || 'ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡'}
                </div>
                <div class="popup-address">${m.address || 'KhÃ´ng cÃ³ Ä‘á»‹a chá»‰'}</div>
                <div class="popup-hours">${m.opening_hours || 'KhÃ´ng cÃ³ thÃ´ng tin giá» má»Ÿ cá»­a'}</div>
                <div class="popup-phone">${m.phone || 'KhÃ´ng cÃ³ sá»‘ Ä‘iá»‡n thoáº¡i'}</div>
                ${m.website ? `<div class="popup-website"><a href="${m.website}" target="_blank">${m.website}</a></div>` : ''}
                <p class="popup-description">${desc}</p>
                <div class="popup-rating-input">
                  <label>ÄÃ¡nh giÃ¡ cá»§a báº¡n:</label>
                  <select onchange="ratePlace('${name}', this.value)">
                    <option value="">Chá»n sá»‘ sao</option>
                    <option value="1">1 sao</option>
                    <option value="2">2 sao</option>
                    <option value="3">3 sao</option>
                    <option value="4">4 sao</option>
                    <option value="5">5 sao</option>
                  </select>
                </div>
                <div class="popup-buttons">
                  <button class="navigate-btn" onclick="navigateTo(${coord.split(',')[0]}, ${coord.split(',')[1]}, '${name}')">Chá»‰ Ä‘Æ°á»ng</button>
                  <button class="favorite-btn" onclick="toggleFavorite('${name}', '${coord}', '${type}', '${image}', '${desc}')">
                    ${favoritePlaces.includes(name) ? 'Bá» yÃªu thÃ­ch' : 'ThÃªm vÃ o yÃªu thÃ­ch'}
                  </button>
                </div>
              </div>
            </div>
          `);
        }
      });

      updateSidebarAndMarkers(document.getElementById('search').value);
    }

    // ThÃªm Ä‘á»‹a Ä‘iá»ƒm má»›i
    document.getElementById('place-form').addEventListener('submit', async (e) => {
      e.preventDefault();
        const place = {
      name: document.getElementById('name').value,
      type: document.getElementById('type').value,
      address: document.getElementById('address').value || null,
      wkb_geometry: `POINT(${document.getElementById('longitude').value} ${document.getElementById('latitude').value})`,
      description: document.getElementById('description').value || null,
      phone: document.getElementById('phone').value || null,
      opening_hours: document.getElementById('opening_hours').value || null,
      website: document.getElementById('website').value || null
    };


      try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${apiUrl}/${id}` : apiUrl;
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(place)
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        resetForm();
        markersByType = {};
        allMarkers = [];
        loadPlaces();
      } catch (error) {
        console.error('Lá»—i khi lÆ°u Ä‘á»‹a Ä‘iá»ƒm:', error);
        alert('KhÃ´ng thá»ƒ lÆ°u Ä‘á»‹a Ä‘iá»ƒm. Vui lÃ²ng kiá»ƒm tra láº¡i.');
      }
    });

    // Sá»­a Ä‘á»‹a Ä‘iá»ƒm
    function editPlace(ogc_fid) {
      const markerData = allMarkers.find(m => m.marker.ogc_fid === ogc_fid);
      if (markerData) {
        const { name, type, coord, image } = markerData;
        const address = markerData.marker.address || '';
        document.getElementById('form-title').textContent = 'Sá»­a Ä‘á»‹a Ä‘iá»ƒm';
        document.getElementById('name').value = name;
        document.getElementById('latitude').value = coord[0];
        document.getElementById('longitude').value = coord[1];
        document.getElementById('type').value = type;
        document.getElementById('address').value = address;
        // KhÃ´ng cáº§n Ä‘iá»n file input, chá»‰ giá»¯ tham chiáº¿u
        document.getElementById('form-container').style.display = 'block';
        document.getElementById('place-form').dataset.id = ogc_fid;
      }
    }

    // XÃ³a Ä‘á»‹a Ä‘iá»ƒm
    async function deletePlace(ogc_fid) {
      if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a Ä‘á»‹a Ä‘iá»ƒm nÃ y?')) {
        try {
          const response = await fetch(`${apiUrl}/${ogc_fid}`, { method: 'DELETE' });
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          markersByType = {};
          allMarkers = [];
          loadPlaces();
        } catch (error) {
          console.error('Lá»—i khi xÃ³a Ä‘á»‹a Ä‘iá»ƒm:', error);
          alert('KhÃ´ng thá»ƒ xÃ³a Ä‘á»‹a Ä‘iá»ƒm. Vui lÃ²ng kiá»ƒm tra láº¡i.');
        }
      }
    }

    // Äáº·t láº¡i form
    function resetForm() {
      document.getElementById('place-form').reset();
      document.getElementById('form-title').textContent = 'ThÃªm Ä‘á»‹a Ä‘iá»ƒm má»›i';
      document.getElementById('form-container').style.display = 'none';
      delete document.getElementById('place-form').dataset.id;
    }

    // Há»§y form
    document.getElementById('cancel-btn').addEventListener('click', resetForm);

    // Gá»i cÃ¡c hÃ m khá»Ÿi táº¡o
    document.addEventListener('DOMContentLoaded', () => {
      requestLocation();
      loadPlaces();
    });
  </script>
</body>
</html>